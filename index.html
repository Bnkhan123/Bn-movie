<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BN MOVIES - বাংলা মুভি অ্যাপ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- CSS ফাইল লিংক করা হলো -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- হেডার -->
        <div class="header">
            <div class="logo">BNMOVIES</div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- লোডিং স্পিনার -->
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>লোড হচ্ছে...</p>
        </div>

        <!-- ক্যাটাগরি ন্যাভিগেশন -->
        <nav class="category-nav" id="category-nav">
            <!-- ডাইনামিক্যালি পপুলেটেড -->
        </nav>

        <!-- সার্চ সেকশন -->
        <div class="search-section">
            <input type="text" id="searchInput" placeholder="মুভি খুঁজুন...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <!-- স্বাগত নোট -->
        <div class="note">
            BN MOVIE অ্যাপে স্বাগতম! সর্বশেষ মুভি এবং টিভি সিরিজ উপভোগ করুন।
        </div>

        <!-- ক্যাটাগরি সেকশন কন্টেইনার -->
        <div id="category-sections">
            <!-- ডাইনামিক্যালি পপুলেটেড -->
        </div>

        <!-- মুভি মডাল -->
        <div id="movieModal" class="modal">
            <div class="modal-content">
                <button class="close-modal">&times;</button>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <!-- জাভাস্ক্রিপ্ট কোড (ফায়ারবেস কনফিগারেশন সহ) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBt4QXKF2bxniZQJOSuVar-0chhj_e_xT8",
            authDomain: "e-commerce-store-9f306.firebaseapp.com",
            projectId: "e-commerce-store-9f306",
            storageBucket: "e-commerce-store-9f306.firebasestorage.app",
            messagingSenderId: "125749736362",
            appId: "1:125749736362:web:31706d499c4027d62e31d3"
        };

        // Firebase ইনিশিয়ালাইজেশন
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // গ্লোবাল ভ্যারিয়েবলস
        const categorySectionsContainer = document.getElementById('category-sections');
        const searchInput = document.getElementById('searchInput');
        const loadingSpinner = document.querySelector('.loading-spinner');
        const movieModal = document.getElementById('movieModal');
        const modalContent = document.getElementById('modalContent');
        const categoryNav = document.getElementById('category-nav');
        const themeToggle = document.getElementById('themeToggle');
        let allMovies = [];

        // থিম টগল
        let isDarkTheme = true;
        themeToggle.addEventListener('click', () => {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light-theme');
            themeToggle.innerHTML = isDarkTheme ? 
                '<i class="fas fa-moon"></i>' : 
                '<i class="fas fa-sun"></i>';
        });

        // লোডিং স্পিনার কন্ট্রোল
        function showLoading() {
            loadingSpinner.classList.add('active');
        }

        function hideLoading() {
            loadingSpinner.classList.remove('active');
        }

        // মুভি লোড ফাংশন
        async function loadMovies() {
            try {
                showLoading();
                const querySnapshot = await getDocs(collection(db, "movies"));
                allMovies = [];
                const moviesByCategory = {};

                querySnapshot.forEach((doc) => {
                    const movie = { id: doc.id, ...doc.data() };
                    allMovies.push(movie);

                    const category = movie.category || 'অন্যান্য';
                    if (!moviesByCategory[category]) {
                        moviesByCategory[category] = [];
                    }
                    moviesByCategory[category].push(movie);
                });

                populateCategories(Object.keys(moviesByCategory));
                displayCategorySections(moviesByCategory);
                hideLoading();

            } catch (error) {
                console.error("মুভি লোড করতে সমস্যা হয়েছে: ", error);
                categorySectionsContainer.innerHTML = '<p>মুভি লোড করতে সমস্যা হয়েছে।</p>';
                hideLoading();
            }
        }

        // মুভি কার্ড তৈরি
        function createMovieCardElement(movie, isGridView = false) {
            const movieCard = document.createElement('div');
            movieCard.classList.add('movie-card');
            if(isGridView) {
                movieCard.classList.add('grid-item');
            }

            const rating = movie.rating ? 
                `<div class="rating"><i class="fas fa-star"></i> ${movie.rating}</div>` : '';
            const qualityLabel = movie.quality ? 
                `<div class="quality-label">${movie.quality}</div>` : '';

            movieCard.innerHTML = `
                ${qualityLabel}
                ${rating}
                <img src="${movie.posterUrl || 'https://via.placeholder.com/300x280?text=No+Image'}" 
                     alt="${movie.title}"
                     loading="lazy">
                <div class="info">
                    <h3>${movie.title}</h3>
                    <div class="buttons">
                        <button class="watch-btn" data-url="${movie.movieUrl || '#'}">
                            <i class="fas fa-play"></i> দেখুন
                        </button>
                        <button class="download-btn" data-url="${movie.movieUrl || '#'}">
                            <i class="fas fa-download"></i> ডাউনলোড
                        </button>
                    </div>
                </div>
            `;

            // ইভেন্ট লিসেনার
            movieCard.querySelector('.watch-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const url = e.target.closest('.watch-btn').dataset.url;
                window.open(url, '_blank');
            });

            movieCard.querySelector('.download-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const url = e.target.closest('.download-btn').dataset.url;
                window.location.href = url;
            });

            movieCard.addEventListener('click', () => showMovieDetails(movie));
            return movieCard;
        }

        // ক্যাটাগরি সেকশন প্রদর্শন
        function displayCategorySections(moviesByCategory) {
            categorySectionsContainer.innerHTML = '';
            const sortedCategories = Object.keys(moviesByCategory).sort();

            sortedCategories.forEach(category => {
                const movies = moviesByCategory[category];
                if (!movies || movies.length === 0) return;

                const section = document.createElement('section');
                section.classList.add('category-section');
                section.id = `category-${category.toLowerCase().replace(/\s+/g, '-')}`;

                const header = document.createElement('div');
                header.classList.add('category-header');
                header.innerHTML = `
                    <h2><i class="fas fa-film"></i> ${category}</h2>
                    <button class="see-all-btn" data-category="${category}">
                        সব দেখুন <i class="fas fa-arrow-right"></i>
                    </button>
                `;

                const movieRow = document.createElement('div');
                movieRow.classList.add('movie-row');

                movies.forEach(movie => {
                    const movieCard = createMovieCardElement(movie);
                    movieRow.appendChild(movieCard);
                });

                section.appendChild(header);
                section.appendChild(movieRow);
                categorySectionsContainer.appendChild(section);
            });

            // See All বাটন ইভেন্ট
            document.querySelectorAll('.see-all-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const category = event.target.dataset.category;
                    filterAndDisplayCategory(category);
                });
            });
        }

        // ক্যাটাগরি ন্যাভিগেশন পপুলেট
        function populateCategories(categories) {
            categoryNav.innerHTML = `
                <button data-category="all" class="active">
                    <i class="fas fa-home"></i> সব
                </button>
            `;

            categories.forEach(category => {
                const button = document.createElement('button');
                button.setAttribute('data-category', category);
                button.innerHTML = `<i class="fas fa-film"></i> ${category}`;
                button.addEventListener('click', () => {
                    document.querySelectorAll('.category-nav button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    filterAndDisplayCategory(category);
                });
                categoryNav.appendChild(button);
            });
        }

        // ক্যাটাগরি ফিল্টার
        function filterAndDisplayCategory(category) {
            categorySectionsContainer.innerHTML = '';
            showLoading();

            const filteredMovies = category === 'all' 
                ? allMovies 
                : allMovies.filter(movie => movie.category === category);

            const section = document.createElement('section');
            section.classList.add('category-section');

            const header = document.createElement('div');
            header.classList.add('category-header');
            header.innerHTML = `
                <h2><i class="fas fa-film"></i> ${category === 'all' ? 'সব মুভি' : category}</h2>
                <button class="see-all-btn" onclick="window.location.reload()">
                    <i class="fas fa-home"></i> হোম
                </button>
            `;

            const movieGrid = document.createElement('div');
            // 'movie-grid-filtered' ক্লাসটি CSS ফাইলে যোগ করা হয়েছে
            movieGrid.classList.add('movie-grid-filtered'); 

            if (filteredMovies.length > 0) {
                filteredMovies.forEach(movie => {
                    const movieCard = createMovieCardElement(movie, true);
                    movieGrid.appendChild(movieCard);
                });
            } else {
                movieGrid.innerHTML = '<p>এই ক্যাটাগরিতে কোন মুভি নেই।</p>';
            }

            section.appendChild(header);
            section.appendChild(movieGrid);
            categorySectionsContainer.appendChild(section);

            hideLoading();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // মুভি সার্চ
        function searchMovies() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                loadMovies();
                return;
            }

            showLoading();
            const filteredMovies = allMovies.filter(movie =>
                (movie.title && movie.title.toLowerCase().includes(searchTerm)) ||
                (movie.description && movie.description.toLowerCase().includes(searchTerm)) ||
                (movie.category && movie.category.toLowerCase().includes(searchTerm))
            );

            categorySectionsContainer.innerHTML = '';
            
            const section = document.createElement('section');
            section.classList.add('category-section');

            const header = document.createElement('div');
            header.classList.add('category-header');
            header.innerHTML = `
                <h2><i class="fas fa-search"></i> "${searchTerm}" এর জন্য সার্চ রেজাল্ট</h2>
                <button class="see-all-btn" onclick="window.location.reload()">
                    <i class="fas fa-home"></i> হোম
                </button>
            `;

            const movieGrid = document.createElement('div');
            movieGrid.classList.add('movie-grid-filtered');

            if (filteredMovies.length > 0) {
                filteredMovies.forEach(movie => {
                    const movieCard = createMovieCardElement(movie, true);
                    movieGrid.appendChild(movieCard);
                });
            } else {
                movieGrid.innerHTML = '<p>কোন মুভি পাওয়া যায়নি।</p>';
            }

            section.appendChild(header);
            section.appendChild(movieGrid);
            categorySectionsContainer.appendChild(section);

            hideLoading();
        }

        // মুভি ডিটেইলস মডাল
        function showMovieDetails(movie) {
            modalContent.innerHTML = `
                <div class="movie-details">
                    <div class="movie-poster">
                        <img src="${movie.posterUrl}" alt="${movie.title}">
                    </div>
                    <div class="movie-info">
                        <h2>${movie.title}</h2>
                        <div class="movie-meta">
                            <div class="meta-item">
                                <i class="fas fa-star"></i>
                                <span>${movie.rating || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-video"></i>
                                <span>${movie.quality || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-film"></i>
                                <span>${movie.category || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="movie-description">
                            ${movie.description || 'কোন বিবরণ নেই'}
                        </div>
                        <div class="buttons">
                            <button class="watch-btn" onclick="window.open('${movie.movieUrl}', '_blank')">
                                <i class="fas fa-play"></i> দেখুন
                            </button>
                            <button class="download-btn" onclick="window.location.href='${movie.movieUrl}'">
                                <i class="fas fa-download"></i> ডাউনলোড
                            </button>
                        </div>
                    </div>
                </div>
                ${movie.trailerUrl ? `
                    <div class="trailer-section">
                        <h3>ট্রেইলার</h3>
                        <iframe src="${movie.trailerUrl}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    </div>
                ` : ''}
            `;
            movieModal.style.display = 'block';
        }

        // মডাল বন্ধ করার ফাংশন
        document.querySelector('.close-modal').addEventListener('click', () => {
            movieModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === movieModal) {
                movieModal.style.display = 'none';
            }
        });

        // সার্চ ইভেন্ট
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchMovies, 500);
        });

        // পেজ লোড হওয়ার সময় মুভি লোড করা
        window.onload = loadMovies;

        // গ্লোবাল ফাংশন এক্সপোজ
        window.filterAndDisplayCategory = filterAndDisplayCategory;
        window.showMovieDetails = showMovieDetails;
    </script>
</body>
</html>
